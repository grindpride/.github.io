console.log('GUI init')

var LineSets = function() {
    this.loadImage = function() {

        var input = $('#imgInp');
        input.click();
    }
    this.color = '#000';
    this.radius = 100;
    this.coloredMode = false;
    this.saveImage = function() {
        text.visible = false;

        setTimeout(function() {
            var img = canvas.toDataURL("image/png");
            var link = document.createElement('a');
            link.href = img;
            link.download = 'mySpiral.png';
            document.body.appendChild(link);
            link.click();
            text.visible = true;
            console.log('ALLO')
        }, 100)

    };
    this.refresh = function() {
        resetSpiral();
    };
    this.step = 100;
    this.width = 1;
};

var line = new LineSets();
var gui = new dat.GUI();
gui.add(line, 'loadImage');
gui.add(line, 'coloredMode');
gui.add(line, 'width').min(0).max(10).step(0.1);
gui.addColor(line, 'color');
gui.add(line, 'radius').min(0).max(200).step(1);

gui.add(line, 'step').min(10).max(150).step(1);
gui.add(line, 'refresh');
gui.add(line, 'saveImage');

function readURL(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();

        reader.onload = function(e) {
            $('#blah').attr('src', e.target.result);

            var image = document.createElement('img');
            image.onload = function() {
                raster = new Raster(image);
                raster.visible = false;
                resetSpiral();
            };
            image.src = event.target.result;

        }

        reader.readAsDataURL(input.files[0]);
    }
}

$("#imgInp").change(function() {
    readURL(this);
});
console.log('script loaded!')
var canvas = document.getElementById('myCanvas');


var path, position, max;
var count = 0;
var grow = false;


var raster = new Raster('grindpride');

raster.visible = false;


raster.on('load', resetSpiral);

var text = new PointText({
    justification: 'right',
    fontSize: 12,
    content: window.FileReader ?
        'Переместите изображение в окно браузера' :
        'to drag & drop images, please use Webkit, Firefox, Chrome or IE 10'
});
var text2 = new PointText({
    justification: 'left',
    fontSize: 12,
    content: 'Grindpride Production'
});

function onFrame(event) {
    if (grow) {
        if (raster.loaded && (view.center - position).length < max) {
            for (var i = 0, l = count / 36 + 1; i < l; i++) {
                growSpiral();
            }
            path.smooth();
        } else {
            grow = false;
            console.log('bang');
            // raster.visible = true;
            // raster.blendMode = 'source-in';


        }
    }
}

function growSpiral() {
    count++;
    var vector = new Point({
        angle: count * 5,
        length: count / line.step
    });
    var rot = vector.rotate(90);
    var color = raster.getAverageColor(position + vector / 2);
    var value = color ? (1 - color.gray) * 3.7 : 0;
    rot.length = line.width * Math.max(value, 0.2);
    path.add(position + vector - rot);
    path.insert(0, position + vector + rot);
    position += vector;
}

function resetSpiral() {
    grow = true;
    raster.blendMode = 'source-in';
    raster.visible = false;
    if (line.coloredMode) {
        console.log(line.coloredMode);
        raster.visible = true;

    }
    // Transform the raster, so it fills the view:
    raster.fitBounds(view.bounds);

    if (path)
        path.remove();

    position = view.center;
    count = 0;
    path = new Path({
        fillColor: line.color,
        closed: true

    });
    path.sendToBack();

    position = view.center;
    max = Math.min(raster.bounds.width, raster.bounds.height) * 0.5 * line.radius / 100;
}

function onResize() {
    if (raster.loaded)
        resetSpiral();
    text.point = view.bounds.bottomRight - [30, 30];
    text2.point = view.bounds.bottomLeft - [-30, 30];
}

function onKeyDown(event) {
    if (event.key == 'space') {
        path.selected = !path.selected;
    }
}

function onDocumentDrag(event) {
    event.preventDefault();
}

function onDocumentDrop(event) {
    event.preventDefault();

    var file = event.dataTransfer.files[0];
    var reader = new FileReader();

    reader.onload = function(event) {
        var image = document.createElement('img');
        image.onload = function() {
            raster = new Raster(image);
            raster.visible = false;
            resetSpiral();
        };
        image.src = event.target.result;
    };
    reader.readAsDataURL(file);
}

document.addEventListener('drop', onDocumentDrop, false);
document.addEventListener('dragover', onDocumentDrag, false);
document.addEventListener('dragleave', onDocumentDrag, false);